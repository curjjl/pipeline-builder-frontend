# 节点样式修改验证指南

## 📅 修改日期
2025-11-07

## 🔧 本次修改内容

### 修改文件列表
1. `src/components/pipeline/nodes/register.ts` - Dataset节点样式定义
2. `src/components/pipeline/GraphCanvas.vue` - 节点添加逻辑修复

### 关键修改点

#### 1. Dataset节点尺寸（register.ts:14-15）
```typescript
width: 240,   // 从220改为240
height: 72,   // 从80改为72
```

#### 2. 图标背景框（register.ts:59-67）
```typescript
'icon-bg': {
  x: 12,
  y: 12,
  width: 32,
  height: 32,
  fill: '#EFF8FF',   // 浅蓝色背景
  rx: 4,
  ry: 4
}
```

#### 3. 文字布局（register.ts:76-94）
```typescript
label: {
  x: 52,        // 图标背景框右侧
  y: 24,        // 与图标区域垂直居中
  fontSize: 14,
  fontWeight: 600  // 加粗
}

meta: {
  x: 52,        // 与标题左对齐
  y: 48,        // 下方位置
  fontSize: 12
}
```

#### 4. 端口位置（register.ts:109-137）
```typescript
in: {
  position: { name: 'right', args: { y: 20 } },  // 右侧上方
  attrs: {
    circle: {
      r: 6,
      visibility: 'visible'  // 始终可见
    }
  }
},
out: {
  position: { name: 'right', args: { y: 52 } },  // 右侧下方
  attrs: {
    circle: {
      r: 6,
      visibility: 'visible'  // 始终可见
    }
  }
}
```

#### 5. 修复attrs覆盖问题（GraphCanvas.vue:520-532）
```typescript
// 修改前：会覆盖默认attrs
const node = graph.addNode({
  id: nodeData.id,
  shape: nodeData.type === 'dataset' ? 'dataset-node' : 'transform-node',
  x: nodeData.x,
  y: nodeData.y,
  data: nodeData,
  attrs: {  // ❌ 这会覆盖register.ts中定义的attrs
    label: { text: nodeData.name },
    meta: { text: metaText }
  }
})

// 修改后：使用node.attr()方法更新
const node = graph.addNode({
  id: nodeData.id,
  shape: nodeData.type === 'dataset' ? 'dataset-node' : 'transform-node',
  x: nodeData.x,
  y: nodeData.y,
  data: nodeData
})

// ✅ 在节点创建后更新文字，不会覆盖其他attrs
node.attr('label/text', nodeData.name)
node.attr('meta/text', metaText)
```

---

## ✅ 验证步骤

### 步骤1：清除浏览器缓存
1. 打开浏览器开发者工具（F12）
2. 右键点击刷新按钮
3. 选择"清空缓存并硬性重新加载"
4. 或者使用快捷键：Ctrl+Shift+R (Windows) 或 Cmd+Shift+R (Mac)

### 步骤2：检查开发服务器
```bash
# 确认服务器正在运行
# 应该看到：
➜  Local:   http://localhost:5175/
➜  Network: http://192.168.202.31:5175/
```

### 步骤3：打开应用并添加节点
1. 访问 http://localhost:5175/
2. 进入Pipeline编辑器
3. 点击"Add data"下拉菜单
4. 选择任意数据集（如Products、Customers、Transactions）

### 步骤4：验证节点样式

检查新添加的节点是否符合以下特征：

#### ✅ 节点尺寸
- [ ] 宽度约为240px（比之前更宽）
- [ ] 高度约为72px（比之前更扁平）
- [ ] 整体宽扁比例接近 3.3:1

#### ✅ 图标区域
- [ ] 左上角有浅蓝色背景方框（32×32）
- [ ] 背景色为 #EFF8FF（非常浅的蓝色）
- [ ] 图标在背景框内居中（20×20）
- [ ] 背景框圆角为4px

#### ✅ 文字布局
- [ ] 节点名称在图标框右侧（不是下方）
- [ ] 名称字体加粗（fontWeight: 600）
- [ ] 名称颜色为深灰色 #101828
- [ ] 列数信息在名称下方
- [ ] 列数信息与名称左对齐（都从x:52开始）
- [ ] 列数信息为灰色 #667085

#### ✅ 端口位置
- [ ] 右侧边缘有两个圆形端口
- [ ] 上方端口位置 y≈20（与图标区域对齐）
- [ ] 下方端口位置 y≈52（与信息区域对齐）
- [ ] 端口始终可见（不需要悬停）
- [ ] 端口半径约6px
- [ ] 端口边框颜色为 #98A2B3

#### ✅ 整体外观
- [ ] 白色背景卡片
- [ ] 边框颜色 #D0D5DD（柔和的灰色）
- [ ] 圆角6px
- [ ] 轻微阴影（模糊4px）
- [ ] 右上角有一个小圆点操作按钮

---

## 🔍 对比参考

### 应该看起来像这样：
```
┌──────────────────────────────────────┐
│ ┌────┐                             ⊙ │
│ │🗂️  │ customers                   ○ │  ← 上方：图标框+名称，右侧：端口
│ └────┘                             ○ │
│        6 columns                     │  ← 下方：信息
└──────────────────────────────────────┘
```

### Palantir官方参考
路径：`docs/Palantir-Pipeline-Image/pipeline-graph-ui-node-01.png`

---

## 🐛 常见问题排查

### 问题1：样式没有变化
**可能原因**：
- 浏览器缓存未清除
- 页面未刷新

**解决方案**：
```bash
# 1. 硬刷新浏览器：Ctrl+Shift+R
# 2. 或者重启开发服务器
Ctrl+C  # 停止服务器
npm run dev  # 重新启动
```

### 问题2：节点仍然使用旧样式
**可能原因**：
- 已存在的节点不会自动更新
- 需要添加新节点

**解决方案**：
1. 删除画布上所有旧节点
2. 重新从"Add data"菜单添加新节点
3. 新节点应该使用新样式

### 问题3：端口不可见
**可能原因**：
- CSS可能覆盖了visibility设置

**检查方法**：
1. 打开浏览器开发者工具
2. 右键点击节点，选择"检查"
3. 查看circle元素的visibility属性
4. 应该为"visible"而不是"hidden"

### 问题4：图标背景不是浅蓝色
**可能原因**：
- icon-bg元素未正确渲染

**检查方法**：
1. 在开发者工具中检查SVG结构
2. 应该看到两个rect元素：
   - body (白色背景)
   - icon-bg (浅蓝色背景)
3. icon-bg应该在icon之前渲染

### 问题5：控制台有错误
**检查内容**：
```javascript
// 打开浏览器控制台（F12 → Console）
// 查找任何红色错误信息
// 常见错误：
// - "Cannot read property 'attr' of undefined"
// - "registerNode is not a function"
```

**解决方案**：
- 检查register.ts文件是否有语法错误
- 确认GraphCanvas.vue正确导入了注册函数
- 重启开发服务器

---

## 🧪 手动测试清单

### 基础功能测试
- [ ] 可以添加新的dataset节点
- [ ] 节点可以拖动
- [ ] 节点可以连接（端口连线）
- [ ] 节点可以选中
- [ ] 节点可以删除

### 样式测试
- [ ] 图标背景为浅蓝色
- [ ] 文字布局正确（图标右侧+下方信息）
- [ ] 端口在右侧边缘可见
- [ ] 节点尺寸为240×72
- [ ] 整体符合Palantir风格

### 交互测试
- [ ] 悬停节点时有视觉反馈
- [ ] 拖动时有阴影效果
- [ ] 选中时有边框高亮
- [ ] 端口悬停时可以看到连接提示

---

## 📊 技术细节

### X6节点注册原理
```typescript
// 1. 注册节点时定义默认样式
Graph.registerNode('dataset-node', {
  inherit: 'rect',
  width: 240,
  height: 72,
  attrs: { /* 默认属性 */ }
})

// 2. 创建节点时不要覆盖attrs
const node = graph.addNode({
  shape: 'dataset-node',
  // ❌ 不要设置attrs: {...}
})

// 3. 使用node.attr()更新特定属性
node.attr('label/text', 'New Name')  // ✅ 正确方式
```

### attrs覆盖机制
- addNode时设置attrs会**完全覆盖**默认attrs
- 使用node.attr(path, value)只更新特定属性
- 路径格式：'selector/attribute'（如'label/text'）

### 端口配置语法
```typescript
// position对象格式（X6官方语法）
position: {
  name: 'right',      // 位置名称：top/bottom/left/right
  args: { y: 20 }     // 参数：指定具体坐标
}

// 简写格式（只能用于基本位置）
position: 'right'     // 只能用于默认位置
```

---

## 📝 下一步优化建议

如果当前修改生效，可以考虑以下进一步优化：

1. **添加悬停效果**
   - 端口高亮
   - 背景色变化
   - 操作按钮显示

2. **优化其他节点类型**
   - Transform节点
   - Join节点
   - Output节点

3. **添加节点动画**
   - 添加节点时的渐入效果
   - 删除节点时的渐出效果

4. **支持主题切换**
   - 浅色主题（当前）
   - 深色主题

---

## 🆘 需要帮助？

如果按照以上步骤验证后样式仍未生效，请提供以下信息：

1. **浏览器控制台截图**（F12 → Console）
2. **节点检查元素截图**（右键节点 → 检查）
3. **当前节点外观截图**
4. **开发服务器输出日志**

这将帮助我们快速定位问题。

---

**文档版本**: v1.0.0
**创建日期**: 2025-11-07
**作者**: Claude Code Assistant
